version: '3.8'

services:
  front_service:
    build:
      context: ${PROJECT_ROOT_PATH}
      dockerfile: ${PROJECT_ROOT_PATH}/front_service/Dockerfile

    container_name: front_service
    hostname: front_service
    environment:
      - SERVICE_NAME=front_service

      - LOG_LEVEL=debug
      - LOG_PATH=${FRONT_SERVICE_LOG_PATH}

      - REST_SERVICE_ADDRESS=front_service:${FRONT_REST_SERVICE_PORT}
      - REST_FRONT_SERVICE_READ_TIMEOUT_SECONDS=2
      - REST_FRONT_SERVICE_WRITE_TIMEOUT_SECONDS=2
      - REST_FRONT_SERVICE_IDLE_TIMEOUT_SECONDS=15
      - REST_FRONT_SERVICE_READ_HEADER_TIMEOUT_SECONDS=2
      - GRPC_SERVICE_ADDRESS=front_service:${FRONT_GRPC_SERVICE_PORT}

      - USER_SERVICE_ADDRESS=user_service:${USER_SERVICE_PORT}
      - SANDBOX_SERVICE_ADDRESS=sandbox_service:${SANDBOX_SERVICE_PORT}
      - DIALOG_SERVICE_ADDRESS=dialog_service:${DIALOG_SERVICE_PORT}
      - COMET_SERVICE_WS_ADDRESS=ws://comet_service:${COMET_SERVICE_PORT}

      - GRPC_CONNECTION_BACKOFF_DELAY_MILLISECONDS=1000
      - GRPC_CONNECTION_BACKOFF_MULTIPLIER=1.6
      - GRPC_CONNECTION_BACKOFF_JITTER=0.2
      - GRPC_CONNECTION_BACKOFF_MAX_DELAY_MILLISECONDS=1000

      - JAEGER_COLLECTOR_ENDPOINT=http://jaeger:${JAEGER_COLLECTOR_PORT}/api/traces

      - MICROSERVICES_GRPC_CONNECTION_TIMEOUT_MILLISECONDS=1000

      - GRPC_CONNECTION_KEEPALIVE_TIME_MILLISECONDS=10000
      - GRPC_CONNECTION_KEEPALIVE_TIMEOUT_MILLISECONDS=20000
      - GRPC_CONNECTION_KEEPALIVE_PERMIT_WITHOUT_STREAM=false

      - GRPC_AUTHORIZARION_HEADER=authorization
      - GRPC_USER_ID_HEADER=${GRPC_USER_ID_HEADER}
      - GRPC_USER_ROLE_HEADER=${GRPC_USER_ROLE_HEADER}

      - AUTH_TOKEN_SECRET_KEY=${AUTH_TOKEN_SECRET_KEY}
      - AUTH_TOKEN_EXPIRATION_SECONDS=0

    volumes:
      - type: bind
        source: ${PROJECT_ROOT_PATH}/_log/front_service.log
        target: ${FRONT_SERVICE_LOG_PATH}
    ports:
      - "8010:${FRONT_REST_SERVICE_PORT}"
      - "8020:${FRONT_GRPC_SERVICE_PORT}"
    networks:
      - default

  user_service:
    build:
      context: ${PROJECT_ROOT_PATH}
      dockerfile: ${PROJECT_ROOT_PATH}/user_service/Dockerfile

    container_name: user_service
    hostname: user_service
    environment:
      - SERVICE_NAME=user_service
      - SERVICE_ADDRESS=user_service:${USER_SERVICE_PORT}

      - DATABASE_URL=postgres://${USER_SERVICE_DATABASE_USERNAME}:${USER_SERVICE_DATABASE_PASSWORD}@user_service_db:5432/${USER_SERVICE_DATABASE_NAME}?sslmode=disable&pool_max_conns=10
      - ENABLE_DATABASE_QUERY_METRICS=true
      - ENABLE_DATABASE_QUERY_TRACING=true
      - DATABASE_OPERATION_TIMEOUT_MILLISECONDS=2000

      - LOG_LEVEL=debug
      - LOG_PATH=${USER_SERVICE_LOG_PATH}

      - AUTH_TOKEN_SECRET_KEY=kqR4VkjWxjKNqgKHHaY7Nq5VQaLFSXqKILL8xlAhK6zrXQvqP2OEix7Lptw4B3I
      - AUTH_TOKEN_EXPIRATION_SECONDS=10000

      - JAEGER_COLLECTOR_ENDPOINT=http://jaeger:${JAEGER_COLLECTOR_PORT}/api/traces

      - ENABLE_METRIC_SERVICE=true
      - METRICS_SERVICE_ADDRESS=user_service:${USER_SERVICE_METRICS_PORT}
      - METRICS_SERVICE_LISTING_SUFFIX=/metrics
      - METRICS_SERVICE_READ_TIMEOUT_SECONDS=1
      - METRICS_SERVICE_WRITE_TIMEOUT_SECONDS=1
      - METRICS_SERVICE_IDLE_TIMEOUT_SECONDS=15
      - METRICS_SERVICE_READ_HEADER_TIMEOUT_SECONDS=2

    volumes:
      - type: bind
        source: ${PROJECT_ROOT_PATH}/_log/user_service.log
        target: ${USER_SERVICE_LOG_PATH}
    ports:
      - "9030:${USER_SERVICE_PORT}"
      - "2112:${USER_SERVICE_METRICS_PORT}"
    depends_on:
      - user_service_db
    networks:
      - default

  user_service_db:
    image: postgres:latest
    container_name: user_service_db
    hostname: user_service_db
    environment:
      - POSTGRES_USER=${USER_SERVICE_DATABASE_USERNAME}
      - POSTGRES_PASSWORD=${USER_SERVICE_DATABASE_PASSWORD}
      - POSTGRES_DB=${USER_SERVICE_DATABASE_NAME}
    ports:
      - "9035:${USER_SERVICE_DATABASE_PORT}"
    networks:
      - default

  # sandbox_service:
  #   build:
  #     context: ${PROJECT_ROOT_PATH}
  #     dockerfile: ${PROJECT_ROOT_PATH}/sandbox_service/Dockerfile

  #   container_name: sandbox_service
  #   hostname: sandbox_service
  #   environment:
  #     - SERVICE_ADDRESS=sandbox_service:${SANDBOX_SERVICE_PORT}
  #     - SERVICE_NAME=sandbox_service

  #     - GRPC_USER_ID_HEADER=${GRPC_USER_ID_HEADER}
  #     - GRPC_USER_ROLE_HEADER=${GRPC_USER_ROLE_HEADER}

  #     - LOG_LEVEL=debug
  #     - LOG_PATH=${SANDBOX_SERVICE_LOG_PATH}

  #     - KAFKA_BROKER_ADDRESS=kafka_broker:${KAFKA_BROKER_PORT}
  #     - KAFKA_PYTHON_3_9_CODE_RUNNER_TOPIC=${KAFKA_PYTHON_3_9_CODE_RUNNER_TOPIC}
  #     - KAFKA_NEW_MESSAGES_TOPIC=${KAFKA_NEW_MESSAGES_TOPIC}
  #     - KAFKA_WRITER_WRITE_TIMEOUT_MILLISECONDS=10000
  #     - KAFKA_WRITER_READ_TIMEOUT_MILLISECONDS=10000

  #     - DATABASE_URI=mongodb://${SANDBOX_SERVICE_DATABASE_USERNAME}:${SANDBOX_SERVICE_DATABASE_PASSWORD}@sandbox_service_mongodb:${SANDBOX_SERVICE_DATABASE_PORT}
  #     - DATABASE_NAME=sandbox
  #     - DATABASE_COLLECTION_NAME=programs
  #     - DATABASE_OPERATION_TIMEOUT_MILLISECONDS=1000
  #     - DATABASE_CONNECTION_TIMEOUT_MILLISECONDS=2000
  #     - DATABASE_STARTUP_RECONNECTION_COUNT=10
  #     - DATABASE_STURTUP_RECONNECTIONION_INTERVAL_MILLISECONDS=500

  #     - JAEGER_COLLECTOR_ENDPOINT=http://jaeger:${JAEGER_COLLECTOR_PORT}/api/traces
  #   volumes:
  #     - type: bind
  #       source: ${PROJECT_ROOT_PATH}/_log/sandbox_service.log
  #       target: ${SANDBOX_SERVICE_LOG_PATH}
  #   ports:
  #     - "9042:${SANDBOX_SERVICE_PORT}"
  #   networks:
  #     - default

  sandbox_worker_service:
    build:
      context: ${PROJECT_ROOT_PATH}
      dockerfile: ${PROJECT_ROOT_PATH}/sandbox_worker_service/docker_images/python/Dockerfile
    container_name: sandbox_worker_service
    hostname: sandbox_worker_service
    environment:
      - LOG_LEVEL=debug
      - LOG_PATH=${SANDBOX_WORKER_SERVICE_LOG_PATH}

      - KAFKA_READER_BROKER_ADDRESS=kafka_broker:${KAFKA_BROKER_PORT}
      - KAFKA_READER_TOPIC=${KAFKA_PYTHON_3_9_CODE_RUNNER_TOPIC}
      - KAFKA_READER_CONSUMER_GROUP_NAME=sandbox_worker_group

      - KAFKA_WRITER_BROKER_ADDRESS=kafka_broker:${KAFKA_BROKER_PORT}
      - KAFKA_WRITER_TOPIC=${KAFKA_PYTHON_CODE_RUNNER_RESULT_TOPIC}
      - KAFKA_WRITER_WRITE_TIMEOUT_MILLISECONDS=10000
      - KAFKA_WRITER_READ_TIMEOUT_MILLISECONDS=10000
    volumes:
      - type: bind
        source: ${PROJECT_ROOT_PATH}/_log/sandbox_worker_service.log
        target: ${SANDBOX_WORKER_SERVICE_LOG_PATH}
    networks:
      - default

  # sandbox_service_mongodb:
  #   image: mongo:latest
  #   container_name: sandbox_service_mongodb
  #   hostname: sandbox_service_mongodb
  #   environment:
  #     - MONGO_INITDB_ROOT_USERNAME=${SANDBOX_SERVICE_DATABASE_USERNAME}
  #     - MONGO_INITDB_ROOT_PASSWORD=${SANDBOX_SERVICE_DATABASE_PASSWORD}
  #   ports:
  #     - "27016:${SANDBOX_SERVICE_DATABASE_PORT}"
  #   networks:
  #     - default

  dialog_service:
    build:
      context: ${PROJECT_ROOT_PATH}
      dockerfile: ${PROJECT_ROOT_PATH}/dialog_service/Dockerfile

    container_name: dialog_service
    hostname: dialog_service
    environment:
      - SERVICE_NAME=dialog_service
      - SERVICE_ADDRESS=dialog_service:${DIALOG_SERVICE_PORT}

      - USER_SERVICE_ADDRESS=user_service:${USER_SERVICE_PORT}
      - USER_SERVICE_CONNECTION_TIMEOUT_MILLISECONDS=2000

      - GRPC_USER_ID_HEADER=${GRPC_USER_ID_HEADER}

      - KAFKA_BROKER_ADDRESS=kafka_broker:${KAFKA_BROKER_PORT}
      - KAFKA_NEW_MESSAGES_TOPIC=${KAFKA_NEW_MESSAGES_TOPIC}
      - KAFKA_VIEWED_MESSAGES_TOPIC=${KAFKA_VIEWED_MESSAGES_TOPIC}
      - KAFKA_WRITER_WRITE_TIMEOUT_MILLISECONDS=10000
      - KAFKA_WRITER_READ_TIMEOUT_MILLISECONDS=10000

      - DATABASE_URL=postgres://${DIALOG_SERVICE_DATABSE_USERNAME}:${DIALOG_SERVICE_DATABSE_PASSWORD}@dialog_service_db:5432/${DIALOG_SERVICE_DATABSE_NAME}?sslmode=disable&pool_max_conns=10
      - DATABASE_OPERATION_TIMEOUT_MILLISECONDS=1000
      - DATABASE_CONNECTION_TIMEOUT_MILLISECONDS=2000
      - DATABASE_STARTUP_RECONNECTION_COUNT=10
      - DATABASE_STURTUP_RECONNECTIONION_INTERVAL_MILLISECONDS=500

      - GRPC_CONNECTION_BACKOFF_DELAY_MILLISECONDS=1000
      - GRPC_CONNECTION_BACKOFF_MULTIPLIER=1.6
      - GRPC_CONNECTION_BACKOFF_JITTER=0.2
      - GRPC_CONNECTION_BACKOFF_MAX_DELAY_MILLISECONDS=1000

      - GRPC_CONNECTION_KEEPALIVE_TIME_MILLISECONDS=10000
      - GRPC_CONNECTION_KEEPALIVE_TIMEOUT_MILLISECONDS=20000
      - GRPC_CONNECTION_KEEPALIVE_PERMIT_WITHOUT_STREAM=false

      - LOG_LEVEL=debug
      - LOG_PATH=${DIALOG_SERVICE_LOG_PATH}

    volumes:
      - type: bind
        source: ${PROJECT_ROOT_PATH}/_log/dialog_service.log
        target: ${DIALOG_SERVICE_LOG_PATH}
    ports:
      - "9031:${DIALOG_SERVICE_PORT}"
    depends_on:
      - dialog_service_db
    networks:
      - default

  dialog_service_db:
    image: postgres:latest
    container_name: dialog_service_db
    hostname: dialog_service_db
    environment:
      - POSTGRES_USER=${DIALOG_SERVICE_DATABSE_USERNAME}
      - POSTGRES_PASSWORD=${DIALOG_SERVICE_DATABSE_PASSWORD}
      - POSTGRES_DB=${DIALOG_SERVICE_DATABSE_NAME}
    ports:
      - "9036:${DIALOG_SERVICE_DATABSE_PORT}"
    networks:
      - default

  comet_service:
    build:
      context: ${PROJECT_ROOT_PATH}
      dockerfile: ${PROJECT_ROOT_PATH}/comet_service/Dockerfile

    container_name: comet_service
    hostname: comet_service
    environment:
      - SERVICE_NAME=comet_service
      - SERVICE_ADDRESS=comet_service:${COMET_SERVICE_PORT}

      - LOG_LEVEL=debug
      - LOG_PATH=${COMET_SERVICE_LOG_PATH}

      - KAFKA_BROKER_ADDRESS=kafka_broker:${KAFKA_BROKER_PORT}
      - KAFKA_NEW_MESSAGES_TOPIC=${KAFKA_NEW_MESSAGES_TOPIC}
      - KAFKA_NEW_MESSAGES_CONSUMER_GROUP_NAME=comet_group
      - KAFKA_VIEWED_MESSAGES_TOPIC=${KAFKA_VIEWED_MESSAGES_TOPIC}
      - KAFKA_VIEWED_MESSAGES_CONSUMER_GROUP_NAME=comet_group

      - SERVICE_READ_TIMEOUT_SECONDS=2
      - SERVICE_WRITE_TIMEOUT_SECONDS=2
      - SERVICE_IDLE_TIMEOUT_SECONDS=15
      - SERVICE_READ_HEADER_TIMEOUT_SECONDS=2

    volumes:
      - type: bind
        source: ${PROJECT_ROOT_PATH}/_log/comet_service.log
        target: ${COMET_SERVICE_LOG_PATH}
    ports:
      - "9072:${COMET_SERVICE_PORT}"
    networks:
      - default

  kafka_broker:
    image: bitnami/kafka:latest
    container_name: kafka_broker
    hostname: kafka_broker
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:${KAFKA_BROKER_PORT},CONTROLLER://:${KAFKA_CONTROLLER_PORT}
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka_broker:${KAFKA_BROKER_PORT}
      - KAFKA_CFG_BROKER_ID=1
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka_broker:${KAFKA_CONTROLLER_PORT}
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_NODE_ID=1
      # - KAFKA_KRAFT_CLUSTER_ID=fM42aVuVTOC2GZbUYkG91g
      - BITNAMI_DEBUG=false
      # volumes:
      #   - /todo/volume:/bitnami/kafka
    ports:
      - "9092:${KAFKA_BROKER_PORT}"
    networks:
      - default

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    hostname: kafka-ui
    environment:
      - KAFKA_CLUSTERS_0_NAME=kraft
      - KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS=kafka_broker:${KAFKA_BROKER_PORT}
      - SERVER_PORT=${KAFKA_UI_PORT}
    ports:
      - "9080:${KAFKA_UI_PORT}"
    networks:
      - default
    depends_on:
      - kafka_broker

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    hostname: jaeger
    ports:
      - "14268:${JAEGER_COLLECTOR_PORT}/udp"
      - "16686:${JAEGER_UI_PORT}"
    networks:
      - default

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    hostname: prometheus
    environment:
      TZ: "Europe/Moscow"
    volumes:
      - ./prometheus:/etc/prometheus/
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    ports:
      - "9090:${PROMETHEUS_UI_PORT}"
    networks:
      - default

networks:
  default:
    driver: bridge
